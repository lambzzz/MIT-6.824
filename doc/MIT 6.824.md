[MIT 6.824 (çŽ°6.5840) é€šå…³è®°å½• - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/631386296)

[MIT 6.824 - çŸ¥ä¹Ž (zhihu.com)](https://www.zhihu.com/column/c_1602038925551517696)

[Golangå¿«é€Ÿå…¥é—¨ï¼šä»Žèœé¸Ÿåˆ°å¤§ä½¬ - wwwn - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/wwwn/p/12804506.html)

------

## Lab 1: MapReduce

![image-20240723232502171](MIT 6.824.assets/image-20240723232502171.png)

coordinatorï¼šå®žçŽ°ä»»åŠ¡è°ƒåº¦ï¼Œé€šè¿‡ä»»åŠ¡é˜Ÿåˆ—ã€ä»»åŠ¡ç”³è¯·å‡½æ•°ç­‰æ–¹æ³•å®žçŽ°ä»»åŠ¡åˆ†é…ï¼Œé€šè¿‡è®¡æ—¶å™¨ã€ä»»åŠ¡æäº¤å‡½æ•°ç­‰æ–¹æ³•ä¿è¯ä»»åŠ¡å®Œæˆï¼Œé€šè¿‡æ£€æŸ¥ç»“æž„ä½“çŠ¶æ€ç³»ç»Ÿè¿è¡Œé˜¶æ®µè¿›è¡Œä¸åŒä»»åŠ¡çš„åˆ†é…å’Œå…³é—­ç³»ç»Ÿï¼Œé€šè¿‡ä¸Šé”ä¿è¯workeräº’æ–¥åœ°è®¿é—®ä»»åŠ¡é˜Ÿåˆ—ç­‰èµ„æºã€‚

workerï¼šé€šè¿‡rpcå¾ªçŽ¯å‘coordinatorç”³è¯·ä»»åŠ¡ï¼Œæ ¹æ®è¿”å›žå€¼çš„ä»»åŠ¡ç±»åž‹ã€æ–‡ä»¶åä»¥åŠreduceræ•°é‡æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ï¼Œmapä»»åŠ¡å°†è¯»å–åˆ°çš„kvæŒ‰ç…§å“ˆå¸Œåˆ†æˆnReduceä¸ªæ–‡ä»¶ä¿å­˜ï¼Œreduceä»»åŠ¡è¯»å–æ‰€æœ‰mr-n-*æ–‡ä»¶è¿›è¡Œåˆå¹¶ï¼Œæ¯ä¸ªä»»åŠ¡å®ŒæˆåŽå‘coordinatoræäº¤ã€‚

rpcï¼šå®šä¹‰rpcè°ƒç”¨ä¸­çš„ç»“æž„ä½“å‚æ•°ç±»åž‹ã€‚

> [MIT 6.824 (çŽ°6.5840) é€šå…³è®°å½• - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/631386296)
>
> [MIT 6.824 Lab1 MapReduce - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/601039547)
>
> [[ç¿»è¯‘\]MapReduce: Simplified Data Processing on Large Clusters - ä»˜å“² - åšå®¢å›­ (cnblogs.com)](https://www.cnblogs.com/fuzhe1989/p/3413457.html)

## Lab 2: Raft

### Part 2A: leader election

> `labrpc` åŒ…æ¨¡æ‹Ÿäº†ä¸€ä¸ªå¯èƒ½ä¸¢åŒ…çš„ç½‘ç»œï¼Œå…¶ä¸­æœåŠ¡å™¨å¯èƒ½æ— æ³•è®¿é—®ï¼Œè¯·æ±‚å’Œå›žå¤å¯èƒ½ä¼šä¸¢å¤±ã€‚`Call()` å‘é€è¯·æ±‚å¹¶ç­‰å¾…å›žå¤ã€‚å¦‚æžœåœ¨è¶…æ—¶é—´éš”å†…æ”¶åˆ°å›žå¤ï¼Œ`Call()` è¿”å›ž `true`ï¼›å¦åˆ™è¿”å›ž `false`ã€‚å› æ­¤ï¼Œ`Call()` å¯èƒ½ä¼šç­‰å¾…ä¸€æ®µæ—¶é—´æ‰è¿”å›žã€‚`false` çš„è¿”å›žå€¼å¯èƒ½ç”±ä»¥ä¸‹åŽŸå› å¯¼è‡´ï¼šæœåŠ¡å™¨å®•æœºã€æœåŠ¡å™¨æ— æ³•è®¿é—®ã€è¯·æ±‚ä¸¢å¤±æˆ–å›žå¤ä¸¢å¤±ã€‚

**ç¡®ä¿ `rf.heartbeats` é€šé“æœ‰è¶³å¤Ÿçš„ç¼“å†²åŒº**ï¼š

- ç»™ `rf.heartbeats` é€šé“æ·»åŠ ç¼“å†²åŒºï¼Œä»¥ä¾¿åœ¨æ²¡æœ‰æŽ¥æ”¶æ–¹æ—¶ä»ç„¶å¯ä»¥å‘é€å¿ƒè·³ä¿¡å·ã€‚
- `rf.heartbeats = make(chan bool, 1)`

**Leaderå› ä¸ºç½‘ç»œé—®é¢˜æ–­å¼€è¿žæŽ¥**ï¼š

- é€šè¿‡æ£€æµ‹å‘é€å…¶ä»–Followerå¿ƒè·³ä¿¡å·æ˜¯å¦æˆåŠŸï¼Œåˆ¤æ–­è‡ªèº«ç½‘ç»œçŠ¶æ€
- å›žé€€ä¸ºFollower

**TODOï¼šPreVoteæœºåˆ¶**

èŠ‚ç‚¹æ–­å¼€è¿žæŽ¥åŽï¼Œä¸æ–­å‘èµ·é€‰ä¸¾è‡ªå¢žä»»æœŸï¼Œé‡æ–°è¿žæŽ¥åŽä¼šæ‰°ä¹±ç³»ç»Ÿ

![image-20240723232539378](MIT 6.824.assets/image-20240723232539378.png)

> [MIT 6.824 (çŽ°6.5840) é€šå…³è®°å½• - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/631386296)
>
> [MIT 6.824 Lab2A Raftï¼šé¢†å¯¼äººé€‰ä¸¾ - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/601771466)
>
> [Raftçš„PreVoteå®žçŽ°æœºåˆ¶ - è…¾è®¯äº‘å¼€å‘è€…ç¤¾åŒº-è…¾è®¯äº‘ (tencent.com)](https://cloud.tencent.com/developer/news/232061)

### Part 2B: log

æˆä¸ºé¢†å¯¼è€…åŽå¯åŠ¨æ—¥å¿—åŒæ­¥çº¿ç¨‹å’ŒcommitIndexæ›´æ–°çº¿ç¨‹ï¼Œé€šè¿‡å®šæ—¶å™¨æˆ–æ¡ä»¶å˜é‡æŽ§åˆ¶å…¶è¿è¡Œ

æ¯ä¸ªserveræ›´æ–°commitIndexåŽï¼Œéœ€è¦å‘applyChé€æ¡ä¼ è¾“logä¿¡æ¯ï¼Œä»¥ä¾›æµ‹è¯•è„šæœ¬è¯†åˆ«

![image-20240723232626179](MIT 6.824.assets/image-20240723232626179.png)

> [MIT 6.824 Lab2B Raftï¼šæ—¥å¿—å¤åˆ¶ - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/602842850)

### Part 2C: persistence

#### **TestFigure82C**

å›¾ 8 å±•ç¤ºäº†ä¸€ç§æƒ…å†µï¼Œä¸€æ¡å·²ç»è¢«å­˜å‚¨åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šçš„è€æ—¥å¿—æ¡ç›®ï¼Œä¹Ÿä¾ç„¶æœ‰å¯èƒ½ä¼šè¢«æœªæ¥çš„é¢†å¯¼äººè¦†ç›–æŽ‰ã€‚

![image-20240723232619804](MIT 6.824.assets/image-20240723232619804.png)

> å›¾ 8ï¼šå¦‚å›¾çš„æ—¶é—´åºåˆ—å±•ç¤ºäº†ä¸ºä»€ä¹ˆé¢†å¯¼äººæ— æ³•å†³å®šå¯¹è€ä»»æœŸå·çš„æ—¥å¿—æ¡ç›®è¿›è¡Œæäº¤ã€‚åœ¨ (a) ä¸­ï¼ŒS1 æ˜¯é¢†å¯¼äººï¼Œéƒ¨åˆ†çš„(è·Ÿéšè€…)å¤åˆ¶äº†ç´¢å¼•ä½ç½® 2 çš„æ—¥å¿—æ¡ç›®ã€‚åœ¨ (b) ä¸­ï¼ŒS1 å´©æºƒäº†ï¼Œç„¶åŽ S5 åœ¨ä»»æœŸ 3 é‡Œé€šè¿‡ S3ã€S4 å’Œè‡ªå·±çš„é€‰ç¥¨èµ¢å¾—é€‰ä¸¾ï¼Œç„¶åŽä»Žå®¢æˆ·ç«¯æŽ¥æ”¶äº†ä¸€æ¡ä¸ä¸€æ ·çš„æ—¥å¿—æ¡ç›®æ”¾åœ¨äº†ç´¢å¼• 2 å¤„ã€‚ç„¶åŽåˆ° (c)ï¼ŒS5 åˆå´©æºƒäº†ï¼›S1 é‡æ–°å¯åŠ¨ï¼Œé€‰ä¸¾æˆåŠŸï¼Œå¼€å§‹å¤åˆ¶æ—¥å¿—ã€‚åœ¨è¿™æ—¶ï¼Œæ¥è‡ªä»»æœŸ 2 çš„é‚£æ¡æ—¥å¿—å·²ç»è¢«å¤åˆ¶åˆ°äº†é›†ç¾¤ä¸­çš„å¤§å¤šæ•°æœºå™¨ä¸Šï¼Œä½†æ˜¯è¿˜æ²¡æœ‰è¢«æäº¤ã€‚å¦‚æžœ S1 åœ¨ (d) ä¸­åˆå´©æºƒäº†ï¼ŒS5 å¯ä»¥é‡æ–°è¢«é€‰ä¸¾æˆåŠŸï¼ˆé€šè¿‡æ¥è‡ª S2ï¼ŒS3 å’Œ S4 çš„é€‰ç¥¨ï¼‰ï¼Œç„¶åŽè¦†ç›–äº†ä»–ä»¬åœ¨ç´¢å¼• 2 å¤„çš„æ—¥å¿—ã€‚åä¹‹ï¼Œå¦‚æžœåœ¨å´©æºƒä¹‹å‰ï¼ŒS1 æŠŠè‡ªå·±ä¸»å¯¼çš„æ–°ä»»æœŸé‡Œäº§ç”Ÿçš„æ—¥å¿—æ¡ç›®å¤åˆ¶åˆ°äº†å¤§å¤šæ•°æœºå™¨ä¸Šï¼Œå°±å¦‚ (e) ä¸­é‚£æ ·ï¼Œé‚£ä¹ˆåœ¨åŽé¢ä»»æœŸé‡Œé¢è¿™äº›æ–°çš„æ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ï¼ˆå› ä¸º S5 å°±ä¸å¯èƒ½é€‰ä¸¾æˆåŠŸï¼‰ã€‚ è¿™æ ·åœ¨åŒä¸€æ—¶åˆ»å°±åŒæ—¶ä¿è¯äº†ï¼Œä¹‹å‰çš„æ‰€æœ‰è€çš„æ—¥å¿—æ¡ç›®å°±ä¼šè¢«æäº¤ã€‚

ä¸ºäº†æ¶ˆé™¤å›¾ 8 é‡Œæè¿°çš„æƒ…å†µï¼ŒRaft æ°¸è¿œä¸ä¼šé€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®çš„æ–¹å¼åŽ»æäº¤ä¸€ä¸ªä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®ã€‚åªæœ‰é¢†å¯¼äººå½“å‰ä»»æœŸé‡Œçš„æ—¥å¿—æ¡ç›®é€šè¿‡è®¡ç®—å‰¯æœ¬æ•°ç›®å¯ä»¥è¢«æäº¤ï¼›å…·ä½“æ¥è¯´ï¼Œæäº¤æ¡ä»¶éœ€è¦åŒæ—¶æ»¡è¶³`count > len(rf.peers)/2 && rf.log[i].Term == rf.currentTerm`

åœ¨æŸ¥æ‰¾commitIndexæ—¶ï¼Œä¹‹å‰å†™çš„äºŒåˆ†å­˜åœ¨é—®é¢˜ï¼Œä½¿ç”¨ä»ŽåŽå¾€å‰éåŽ†æ–¹æ³•

#### **TestFigure8Unreliable2C**

æµ‹è¯•åœ¨é«˜å»¶è¿ŸRPCä¸‹çš„å¤„ç†ï¼Œä¼šæ”¶åˆ°å¾ˆå¤šæ—§çš„æ¶ˆæ¯ï¼Œéœ€è¦è€ƒè™‘å¯¹è¿‡æœŸçš„è€çš„RPCå¤„ç†è¯·æ±‚åº”è¯¥åšå‡ºä»€ä¹ˆæ ·çš„å¤„ç†

1.æ—¥å¿—ä¸è¿›è¡Œç›´æŽ¥è¦†ç›–ï¼Œåªæœ‰RPCæ—¥å¿—ä¸Žè‡ªèº«æ—¥å¿—ä¸åŒ¹é…ï¼Œæ‰èƒ½å°†åŽç»­æ—¥å¿—åˆ é™¤å¹¶æ›´æ–°ï¼Œé˜²æ­¢æŽ¥æ”¶åˆ°æ—§çš„RPCå¯¼è‡´æ—¥å¿—ç¼©çŸ­

> å¦‚æžœçŽ°æœ‰æ¡ç›®ä¸Žæ–°æ¡ç›®å†²çªï¼ˆç´¢å¼•ç›¸åŒä½†ä»»æœŸä¸åŒï¼‰ï¼Œè¯·åˆ é™¤çŽ°æœ‰æ¡ç›®åŠå…¶åŽé¢çš„æ‰€æœ‰æ¡ç›®ã€‚
> è¿™é‡Œçš„ifæ˜¯è‡³å…³é‡è¦çš„ã€‚å¦‚æžœè·Ÿéšè€…æ‹¥æœ‰å¼•å¯¼è€…å‘é€çš„æ‰€æœ‰æ¡ç›®ï¼Œåˆ™è·Ÿéšè€…ä¸å¾—æˆªæ–­å…¶æ—¥å¿—ã€‚å¿…é¡»ä¿ç•™é¢†å¯¼è€…å‘é€çš„æ¡ç›®ä¹‹åŽçš„ä»»ä½•å…ƒç´ ã€‚è¿™æ˜¯å› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šæ”¶åˆ°æ¥è‡ªé¢†å¯¼è€…çš„è¿‡æ—¶RPCï¼Œè€Œæˆªæ–­æ—¥å¿—æ„å‘³ç€â€œæ”¶å›žâ€æˆ‘ä»¬å¯èƒ½å·²ç»å‘Šè¯‰é¢†å¯¼è€…æˆ‘ä»¬æ—¥å¿—ä¸­çš„æ¡ç›®ã€‚

2.åœ¨PrevLogTermä¸åŒ¹é…æ—¶ï¼Œé€šè¿‡ä¸€æ¬¡æ€§è¶Šè¿‡å†²çªä»»æœŸï¼Œreplyä¸­è¿”å›žNextIndexï¼›åœ¨ä¸åŒ¹é…é‡è¯•æƒ…å†µä¸‹ï¼ŒNextIndexåªèƒ½é€’å‡ï¼›AppendEntriesæˆåŠŸçš„NextIndexå’Œå¤±è´¥çš„NextIndexå¯èƒ½å­˜åœ¨å†²çª

***ä»¥ä¸Šæ–¹æ³•åœ¨Leaderä¸ŽFollowerçš„æ—¥å¿—å­˜åœ¨è¾ƒå¤šçš„ä¸ä¸€è‡´æƒ…å†µä¸‹ï¼Œä»ç„¶éœ€è¦å¤šæ¬¡RPCé‡è¯•ï¼Œå…¶åœ¨ä¸å¯é RPCçŽ¯å¢ƒä¸‹è¾ƒéš¾å¿«é€Ÿè¾¾æˆä¸€è‡´ï¼Œä¸”åœ¨TestFigure8Unreliable2Cå®žéªŒä¸­è¾ƒä¸ºé¢‘ç¹çš„Leaderåˆ‡æ¢ï¼Œè®©å®žçŽ°æ—¥å¿—çš„ä¸€è‡´æ€§æ›´åŠ çœ‹è„¸*** ==æ›´æ–°ï¼šå¤±è´¥åŽŸå› ä¸ºä»£ç é€»è¾‘å†™é”™å¯¼è‡´é˜»å¡žï¼Œè§ä¸‹æ–‡==

é€šè¿‡åŸºäºŽåˆ†å—çš„æ–¹æ³•è¿”å›žFollowerçš„æ—¥å¿—åˆ‡ç‰‡ï¼ŒLeaderåœ¨å…¶ä¸­æ‰¾åˆ°ä»»æœŸä¸€è‡´çš„æ—¥å¿—Indexä½œä¸ºNextIndexï¼Œå®žçŽ°ä¸€æ¬¡RPCé‡è¯•å°±èƒ½å®ŒæˆåŒæ­¥

3.åœ¨æŽ¥æ”¶å¿ƒè·³RPCçš„è¿”å›žæ—¶ï¼ŒåŒæ ·éœ€è¦æ‰§è¡ŒæŒ‡å®šçš„ä»»æ„æ£€æŸ¥

> æˆ‘ä»¬çš„è®¸å¤šå­¦ç”Ÿè®¤ä¸ºå¿ƒè·³åœ¨æŸç§ç¨‹åº¦ä¸Šæ˜¯â€œç‰¹æ®Šçš„â€ï¼›å½“å¯¹ç­‰ç«¯æŽ¥æ”¶åˆ°å¿ƒè·³æ—¶ï¼Œå®ƒåº”è¯¥å°†å…¶ä¸Žéžå¿ƒè·³RPCåŒºåˆ«å¯¹å¾…ã€‚ç‰¹åˆ«æ˜¯ï¼Œè®¸å¤šäººåªéœ€åœ¨æ”¶åˆ°å¿ƒè·³æ—¶é‡ç½®ä»–ä»¬çš„é€‰ä¸¾è®¡æ—¶å™¨ï¼Œç„¶åŽè¿”å›žæˆåŠŸï¼Œè€Œä¸æ‰§è¡Œå›¾2ä¸­æŒ‡å®šçš„ä»»ä½•æ£€æŸ¥ã€‚è¿™æ˜¯æžå…¶å±é™©çš„ã€‚é€šè¿‡æŽ¥å—RPCï¼Œè·Ÿéšè€…éšå«åœ°å‘Šè¯‰å¼•å¯¼è€…ï¼Œä»–ä»¬çš„æ—¥å¿—ä¸Žå¼•å¯¼è€…çš„æ—¥å¿—åŒ¹é…ï¼Œç›´åˆ°å¹¶åŒ…æ‹¬å‚æ•°ä¸­åŒ…å«çš„ã€‚æ”¶åˆ°å›žå¤åŽï¼Œé¢†å¯¼è€…å¯èƒ½ä¼šï¼ˆé”™è¯¯åœ°ï¼‰å†³å®šæŸäº›æ¡ç›®å·²å¤åˆ¶åˆ°å¤§å¤šæ•°æœåŠ¡å™¨ï¼Œå¹¶å¼€å§‹æäº¤ã€‚AppendEntriesprevLogIndexAppendEntries

4.**ä¹‹å‰å®žéªŒä¸­çš„å®žçŽ°å­˜åœ¨é—®é¢˜ï¼Œä¸Žè®ºæ–‡ç»†èŠ‚ä¸ç¬¦ï¼š**

- èŠ‚ç‚¹è¶…æ—¶å‘èµ·é€‰ä¸¾æ—¶ï¼Œé‡ç½®è‡ªå·±çš„é€‰ä¸¾è¶…æ—¶è®¡æ—¶å™¨ï¼›ä»»æœŸè½åŽæ—¶ï¼Œæ›´æ–°å¹¶é‡ç½®è®¡æ—¶å™¨
- å¦‚æžœå¯¹äºŽä¸€ä¸ªè·Ÿéšè€…ï¼Œæœ€åŽæ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼å¤§äºŽç­‰äºŽ nextIndexï¼ˆ`lastLogIndex â‰¥ nextIndex`ï¼‰ï¼Œåˆ™å‘é€ä»Ž nextIndex å¼€å§‹çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ï¼ˆåˆ¤æ–­nextIndexè€Œä¸æ˜¯matchIndexï¼‰
- å¦‚æžœé¢†å¯¼äººçš„å·²çŸ¥å·²æäº¤çš„æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å¤§äºŽæŽ¥æ”¶è€…çš„å·²çŸ¥å·²æäº¤æœ€é«˜æ—¥å¿—æ¡ç›®çš„ç´¢å¼•ï¼ˆ`leaderCommit > commitIndex`ï¼‰ï¼Œåˆ™æŠŠæŽ¥æ”¶è€…çš„å·²çŸ¥å·²ç»æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼•commitIndex é‡ç½®ä¸º é¢†å¯¼äººçš„å·²çŸ¥å·²ç»æäº¤çš„æœ€é«˜çš„æ—¥å¿—æ¡ç›®çš„ç´¢å¼• leaderCommit æˆ–è€…æ˜¯ **ä¸Šä¸€ä¸ªæ–°æ¡ç›®çš„ç´¢å¼•**ï¼ˆè€Œä¸æ˜¯æ—¥å¿—æœ€åŽæ¡ç›®çš„ç´¢å¼•ï¼‰ å–ä¸¤è€…çš„æœ€å°å€¼
- commitIndexåªèƒ½å¢žåŠ ä¸èƒ½å‡å°ï¼Œå› æ­¤åœ¨é‡ç½®ä¸º**ä¸Šä¸€ä¸ªæ–°æ¡ç›®çš„ç´¢å¼•**æ—¶è¦å†æ¬¡åˆ¤æ–­
- ä»»ä½•å¸¦æœ‰é•¿æ—¶é—´è¿è¡Œå¾ªçŽ¯çš„goroutineåº”è¯¥è°ƒç”¨killed()æ¥æ£€æŸ¥å®ƒæ˜¯å¦åº”è¯¥åœæ­¢ã€‚

##### unreliableåŽŸç†ï¼š

![image-20240723232641495](MIT 6.824.assets/image-20240723232641495.png)

![image-20240723232647493](MIT 6.824.assets/image-20240723232647493.png)

##### å¤±è´¥åŽŸå› ï¼š

ä¹‹å‰çš„åŒæ­¥æ—¥å¿—/å‘é€å¿ƒè·³å®žçŽ°ä¸ºï¼Œé¢†å¯¼è€…å¯¹æ¯ä¸ªè·Ÿéšè€…å•ç‹¬å¼€ä¸€ä¸ªçº¿ç¨‹ï¼Œåœ¨çº¿ç¨‹ä¸­è¿›è¡Œå‘é€RPCã€ç­‰å¾…RPCã€å¤„ç†RPCã€ç¡çœ çš„å¾ªçŽ¯ã€‚çœ‹ä¼¼æ˜¯å¤šçº¿ç¨‹+ç­‰å¾…RPCæ—¶è§£é”ï¼Œ**å®žé™…ä¸Šå¯¹äºŽæ¯ä¸ªè·Ÿéšè€…çš„RPCå¾ªçŽ¯æ˜¯é˜»å¡žçš„**ï¼Œéœ€è¦ç­‰å¾…æŽ¥æ”¶å»¶è¿Ÿ+ç¡çœ æ—¶é—´æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ¬¡RPCå¾ªçŽ¯ï¼Œä¸Žæ¯éš”å›ºå®šæ—¶é—´å‘é€RPCçš„è®¾è®¡ä¸ç¬¦ï¼Œé€ æˆä¸èƒ½åŠæ—¶åŒæ­¥æ—¥å¿—/å‘é€å¿ƒè·³ã€‚

##### ä¿®æ”¹ï¼š

ç»†åŒ–å°è£…åŒæ­¥æ—¥å¿—/å‘é€å¿ƒè·³å¾ªçŽ¯ï¼Œé¢†å¯¼è€…å¯åŠ¨ä¸€ä¸ªå¾ªçŽ¯RPCçº¿ç¨‹ï¼Œçº¿ç¨‹ä¸­æ¯éš”å›ºå®šæ—¶é—´å¯¹æ¯ä¸ªè·Ÿéšè€…å¯åŠ¨è¿›è¡Œä¸€æ¬¡RPCçš„çº¿ç¨‹ï¼ŒåŒ…å«å‘é€RPCã€ç­‰å¾…RPCã€å¤„ç†RPCã€‚

![image-20240723232655149](MIT 6.824.assets/image-20240723232655149.png)

> [MIT 6.824 Lab2Cï¼šRaft æ—¥å¿—æŒä¹…åŒ– - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/603432276)
>
> [Students' Guide to Raft :: Jon Gjengset (thesquareplanet.com)](https://thesquareplanet.com/blog/students-guide-to-raft/)

### Part 2D: log compaction

èŠ‚ç‚¹çš„å„ä¸ªçŠ¶æ€é‡‡ç”¨ç»å¯¹ç´¢å¼•è®°å½•ï¼Œä½¿ç”¨`rf.log`åŠå…¶é•¿åº¦ç­‰æ•°æ®æ—¶é‡‡ç”¨ç›¸å¯¹ç´¢å¼•ï¼Œä¸¤è€…é€šè¿‡`lastsnapshotIndex`è½¬æ¢ã€‚åœ¨ä½¿ç”¨ç›¸å¯¹ç´¢å¼•æ—¶ï¼Œå¯¹ç´¢å¼•æ˜¯å¦è¶Šç•Œè¿›è¡Œåˆ¤æ–­ï¼Œå¹¶é‡‡å–ä¼ é€’å¿«ç…§è§£å†³ä¸åŒæ­¥é—®é¢˜ï¼Œéœ€è¦ä¼ é€’å¿«ç…§çš„åœºæ™¯æœ‰ï¼šé™„åŠ æ—¥å¿—ä¸åŒ¹é…æ—¶å›žæº¯åˆ°å¿«ç…§ä½ç½®ã€å‘èµ·åŒæ­¥æ—¥å¿—/å‘é€å¿ƒè·³æ—¶è·Ÿéšè€…çš„`nextIndex`å·²ç»å­˜åœ¨å¿«ç…§ä¸­ã€‚

ç³»ç»Ÿåœ¨æŽ¥æ”¶åˆ°è¦æäº¤çš„æ—¥å¿—åŽï¼Œå¦‚è‹¥éœ€ç”Ÿæˆå¿«ç…§ï¼Œåˆ™ä¼šè°ƒç”¨`Snapshot` å‡½æ•°ï¼Œç„¶åŽå†è¿”å›žï¼Œæ‰€ä»¥åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå‘`applyCh` å‘é€æ¶ˆæ¯ï¼Œä¸èƒ½æ‹¥æœ‰é”ï¼Œå¦åˆ™ä¼šå‘ç”Ÿæ­»é”

ç¨‹åºè°ƒè¯•ï¼š

- æ‰§è¡Œå¿«ç…§çš„æ—¶å€™ï¼Œç¡®ä¿å¿«ç…§æœ€åŽæ—¥å¿—å³`rf.log[0]`çš„ä»»æœŸæ­£ç¡®ã€‚å¿«ç…§ç´¢å¼•å¤§äºŽç­‰äºŽæ—¥å¿—æœ€åŽç´¢å¼•æ—¶ï¼Œåˆå§‹åŒ–æ—¥å¿—ï¼›å¿«ç…§ç´¢å¼•å°äºŽæ—¥å¿—æœ€åŽç´¢å¼•ã€å¤§äºŽä¸Šæ¬¡å¿«ç…§ç´¢å¼•æ—¶ï¼Œæ›´æ–°æ—¥å¿—ä¸ºç¼©å‡åŽçš„ã€‚
- å‘èµ·RPCèŽ·å¾—é”åŽï¼Œåˆ¤æ–­è‡ªèº«çŠ¶æ€æ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•æ”¾å¼ƒRPCã€‚

![image-20240723232703358](MIT 6.824.assets/image-20240723232703358.png)

> [MIT 6.824 Lab2Dï¼šRaft å¿«ç…§æœºåˆ¶ - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/604069871)

å®žéªŒ2æµ‹è¯•30æ¬¡é€šè¿‡

![image-20240723232718607](MIT 6.824.assets/image-20240723232718607.png)

## Lab 3: Fault-tolerant Key/Value Service

### Part A: Key/value service without snapshots

##### çº¿æ€§åŒ–è¯­ä¹‰

åŽŸæ–¹æ¡ˆï¼šclientåœ¨å‡†å¤‡å‘é€ä¸€æ¡å‘½ä»¤çš„æ—¶å€™ç”Ÿæˆä¸€ä¸ªéšæœºæ•°ä½œä¸ºè¯¥å‘½ä»¤çš„IDï¼Œåœ¨å‘½ä»¤è¢«æˆåŠŸæ‰§è¡Œå‰æ‰€æœ‰é‡å¤å°è¯•éƒ½ä»¥è¿™ä¸ªæ•°ä½œä¸ºIDã€‚serveråœ¨æ‰§è¡Œå‘½ä»¤åŽå°†éšæœºæ•°å‚¨å­˜åœ¨å“ˆå¸Œè¡¨ä¸­ï¼ŒåŽç»­åœ¨æ‰§è¡Œå‘½ä»¤å‰æŸ¥è¡¨ï¼Œè‹¥å­˜åœ¨åˆ™è·³è¿‡æ‰§è¡Œï¼›å“ˆå¸Œè¡¨å®šæœŸæ¸…ç†ã€‚ä¸è¶³ï¼šå“ˆå¸Œè¡¨æ¸…ç†é˜ˆå€¼100ä»¥ä¸Šå¤§æ¦‚èƒ½æ»¡è¶³ä½¿ç”¨éœ€æ±‚ï¼Œä½†åœ¨3Bæµ‹è¯•ä¸­å“ˆå¸Œè¡¨å å¿«ç…§ç©ºé—´è¿‡å¤§2000>500

æ›´æ–°åŽæ–¹æ¡ˆï¼šæ¯ä¸€ä¸ªclientç”Ÿæˆä¸€ä¸ªéšæœºæ•°ä½œä¸ºè‡ªå·±çš„IDï¼Œå†é€šè¿‡ä¸€ä¸ªé€’å¢žçš„æ•°å­—ä½œä¸ºå‘½ä»¤çš„åºåˆ—å·ï¼Œä¸¤ä¸ªæ•°å­—ç¡®å®šä¸€æ¡å‘½ä»¤ï¼›serveræ‰§è¡Œä¸€ä¸ªå‘½ä»¤åŽè®°å½•ä¸‹è¯¥clientçš„åºåˆ—å·ï¼Œå°äºŽåºåˆ—å·çš„å‘½ä»¤è§†ä¸ºé‡å¤ã€‚ä¸è¶³ï¼šéšç€clientçš„å¢žå¤šæˆ–é‡å¯ï¼ŒclientIdå­—æ®µä¸æ–­å¢žåŠ å ç”¨å†…å­˜ï¼Œå¯èƒ½éœ€è¦clientå‘é€å¿ƒè·³ä¿¡å·ä»¥ç»´æŒå¯¹åº”å­—æ®µæ•°æ®çš„å­˜åœ¨

![image-20240723232742714](MIT 6.824.assets/image-20240723232742714.png)

### Part B: Key/value service with snapshots

ç”Ÿæˆå¿«ç…§ä¸åº”è¯¥ä¸ŽæŽ¥æ”¶ä¸€è‡´åŒ–æ—¥å¿—åœ¨åŒä¸€å‡½æ•°ä¸­è¿›è¡Œï¼Œä¼šå¯¼è‡´æŒä¹…åŒ–å†…å®¹ä¸€è¿‡é˜ˆå€¼å°±éœ€è¦ç”Ÿæˆå¿«ç…§ï¼Œæ‹–æ…¢é˜»å¡žæŽ¥æ”¶æ—¥å¿—ï¼›è€Œåº”è¯¥é€šè¿‡ç‹¬ç«‹çº¿ç¨‹æ¯éš”ä¸€æ®µæ—¶é—´æ£€æµ‹ç”Ÿæˆå¿«ç…§ï¼Œåœ¨è¾“å…¥æ—¥å¿—é‡å¤§çš„æƒ…å†µä¸‹ï¼Œä¸€æ¬¡æ€§ç”Ÿæˆæœ€æ–°å¿«ç…§

å¿«ç…§éœ€è¦ä¿å­˜çº¿æ€§åŒ–è¯­ä¹‰æ‰€éœ€æ•°æ®ç»“æž„ï¼Œä»¥é˜²å´©æºƒé‡å¯åŽçº¿æ€§åŒ–è¯­ä¹‰å¤±è´¥

æ­¤å¤–åœ¨raftä¸­ä¿®æ”¹äº†å¿«ç…§ä¸­çš„æ¡ä»¶åˆ¤æ–­ï¼Œå¢žåŠ ç´¢å¼•ä¸Žæ—¥å¿—é•¿åº¦ç›¸åŒæ—¶çš„æ¡ä»¶ï¼Œé‡æ–°æµ‹è¯•2Dé€šè¿‡

![image-20240723232750810](MIT 6.824.assets/image-20240723232750810.png)

> [MIT 6.824 Lab3ï¼ŒLab4A - çŸ¥ä¹Ž (zhihu.com)](https://zhuanlan.zhihu.com/p/609273507)

## Lab 4: Sharded Key/Value Service

### Part A: The Shard controller

ç›®æ ‡æž„å»ºç±»ä¼¼Lab3Bçš„åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿè®°å½•Configï¼Œæ“ä½œæ–¹å¼å˜ä¸ºJoinã€Leaveã€Moveã€Queryï¼Œéœ€è¦è§£å†³é—®é¢˜ä¸ºåŠ å…¥å’Œç¦»å¼€åŽgroupçš„shardså¹³è¡¡ï¼Œgroupä¸­çš„`gid -> servers[]`åªéœ€æŒ‰æ“ä½œå­˜å‚¨å’Œåˆ é™¤ã€‚ä¸»è¦æ€è·¯é€šè¿‡è´ªå¿ƒæ±‚å‡ºå“ªäº›ç»„é‡Šæ”¾ä»¥åŠå“ªäº›ç»„æŽ¥æ”¶shardï¼Œæ³¨æ„é‡Šæ”¾å’ŒæŽ¥æ”¶ä¸åŒshardsé¡ºåºè¦ç¡®å®šï¼Œå¦åˆ™å¤šä¸ªserveråœ¨åŒä¸€æ“ä½œåŽçš„Configå°†ä¸åŒ

![image-20240723232812612](MIT 6.824.assets/image-20240723232812612.png)

> [MIT-6.824-lab4A-2022(ä¸‡å­—è®²è§£-ä»£ç æž„å»ºï¼‰_mit6.824 lab4-CSDNåšå®¢](https://blog.csdn.net/weixin_45938441/article/details/125386091)
>
> [MIT6.824-lab4A-The Shard controller(åŸºäºŽRaftçš„Shard KVæ•°æ®åº“-åˆ†ç‰‡æŽ§åˆ¶å™¨)_6.824lab4 shardkv-CSDNåšå®¢](https://blog.csdn.net/qq_44766883/article/details/126430294?spm=1001.2101.3001.6650.4&utm_medium=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-4-126430294-blog-125386091.235^v43^pc_blog_bottom_relevance_base4&depth_1-utm_source=distribute.pc_relevant.none-task-blog-2~default~BlogCommendFromBaidu~Rate-4-126430294-blog-125386091.235^v43^pc_blog_bottom_relevance_base4&utm_relevant_index=9)

### Part B: Sharded Key/Value Server

æ¯ä¸ªServerç»´æŠ¤ä¿å­˜`config`å’Œ`ownedShards[]`ï¼Œå‰è€…ä¿å­˜é…ç½®ä¿¡æ¯ï¼ŒåŽè€…è¡¨ç¤ºå½“å‰å®žé™…çš„shardå­˜åœ¨çŠ¶æ€ã€‚åœ¨æŽ¥æ”¶Clientçš„RPCæ—¶ä¸å¯¹ç›¸åº”ä¿¡æ¯è¿›è¡Œæ£€æŸ¥ï¼Œå› ä¸ºserverçš„é…ç½®ä¿¡æ¯çš„æ›´æ–°åŒæ ·é€šè¿‡raftä¸€è‡´åŒ–ï¼Œæ­¤åˆ»ä¿¡æ¯ä¸åŒ¹é…ä¸ä»£è¡¨åœ¨åº”ç”¨æ—¶ä¸åŒ¹é…ï¼›è€Œæ˜¯åœ¨applyæ“ä½œæ—¶æ£€æŸ¥å®žé™…shardæ˜¯å¦å­˜åœ¨ä»¥åŠconfigIdæ˜¯å¦ä¸€è‡´ï¼Œä¸€æ—¦æ£€æŸ¥æœ‰è¯¯åˆ™è¿”å›žErrWrongGroup

shardKVä¸­æ¯ä¸ªgroupçš„é…ç½®æ›´æ–°ç”±å„è‡ªçš„Leaderè´Ÿè´£ï¼Œåœ¨æ›´æ–°é…ç½®å‰éœ€æ£€æŸ¥å½“å‰é…ç½®æ˜¯å¦å·²ç»å®Œæˆï¼Œå³`config`å’Œ`ownedShards[]`ä¸€è‡´ã€‚æ›´æ–°é…ç½®ä¸­æ‰€æœ‰æƒçš„å˜æ›´æœ‰å‡ ç§ï¼šæŒæœ‰æƒä¸å˜ã€ä¸æŒæœ‰ã€è½¬ç§»ã€æ— äººæŒæœ‰->æ–°æŒæœ‰ï¼Œåˆ†åˆ«å¯¹åº”ä¸‰ç§æ“ä½œï¼š`LeaveShard`ã€`MoveShard`ã€`JoinShard`ï¼Œç»„å†…æ•°æ®éœ€è¦ä¿æŒä¸€è‡´æ€§å› æ­¤shardæ“ä½œéœ€è¦é€šè¿‡raftå®žçŽ°ã€‚åœ¨serveræ”¶åˆ°raftçš„opåŽï¼ŒLeaveShardå’ŒJoinShardåˆ†åˆ«åˆ é™¤å’Œæ·»åŠ å¯¹åº”çš„shardæ•°æ®å¹¶ä¿®æ”¹ownedShardsï¼›MoveShardåˆ™éœ€è¦ä¿®æ”¹ownedShardså¹¶ç»™ç›®æ ‡groupçš„Leaderå‘é€åŒ…å«shardæ•°æ®çš„RPCï¼Œç›®æ ‡serverå†å°†shardæ•°æ®ä½œä¸ºJoinShardæ“ä½œè¾“å…¥raftã€‚æ­¤å¤–`config`çš„æ›´æ–°åŒæ ·éœ€è¦é€šè¿‡raftåŒæ­¥åˆ°å…¶ä»–serverä¸Šã€‚

å®¢æˆ·ç«¯åœ¨æŽ¥æ”¶åˆ°`ErrWrongGroup`ä¸åº”è¯¥æ”¹å˜åºåˆ—å·ã€‚å› ä¸ºå½“è®¾è®¡ä¸ºæ›´æ–°åºåˆ—å·ï¼Œä¸”å®¢æˆ·ç«¯åªæœ‰åœ¨æŽ¥æ”¶ErrWrongGroupæ—¶æ‰ä¼šé‡è¯¢å¹¶è‡ªå¢žåºåˆ—å·ï¼ŒErrWrongGroupå¯¹åº”çš„æ“ä½œRPCå¯èƒ½è¿”å›žä¸¢å¤±ï¼ŒæœåŠ¡ç«¯è®¤ä¸ºErrWrongGroupåŽä¸ä¼šæŽ¥æ”¶åˆ°ç›¸åŒåºåˆ—å·çš„æ“ä½œï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯é‡æ–°å‘é€çš„ç›¸åŒåºåˆ—å·çš„æ“ä½œå°±ä¼šè¢«è®¤ä¸ºé‡å¤æ‰§è¡Œï¼Œä»Žè€Œè¿”å›žæ‰§è¡ŒæˆåŠŸè€Œå®žé™…ä¸æ‰§è¡Œï¼Œä¸¢å¤±äº†æ•°æ®ã€‚å†è€ƒè™‘ä¸€ç§æƒ…å†µï¼Œå®¢æˆ·ç«¯åœ¨å°è¯•ä¸€è½®serveræ²¡æœ‰æˆåŠŸåŽå°±é‡è¯¢configæ›´æ–°åºåˆ—å·ï¼Œæ­¤æ—¶è‹¥RPCè°ƒç”¨æˆåŠŸå´è¿”å›žä¸¢å¤±ï¼Œå®¢æˆ·ç«¯è‡ªå¢žåºåˆ—å·å°†é‡å¤appendã€‚å®žé™…å¯è¡Œæ–¹æ¡ˆä¸ºå®¢æˆ·ç«¯ä¸æ”¹å˜åºåˆ—å·ï¼Œè€ŒæœåŠ¡ç«¯åœ¨ErrWrongGroupåŽå°†å·²æŽ¥æ”¶çš„åºåˆ—å·å‡ä¸€ã€‚

#### TestConcurrent1

è°ƒè¯•ä¸­å‡ºçŽ°é‡å¤Appendé—®é¢˜ï¼Œè°ƒæ•´æµ‹è¯•æ¡ä»¶åŽå‘çŽ°é‡å¤appendåªä¼šå‡ºçŽ°åœ¨serverçš„é‡å¯ä¹‹åŽã€‚æ‰“å°æ—¥å¿—åŽå‘çŽ°é‡å¤appendæ˜¯åœ¨shardè½¬ç§»å‰åŽåœ¨ä¸åŒgroupè¿›è¡Œçš„ï¼Œé—®é¢˜åœ¨äºŽappendåœ¨ç¬¦åˆé…ç½®æ¡ä»¶æ—¶ä¼šæˆåŠŸæ‰§è¡Œå¹¶å®žçŽ°çº¿æ€§åŒ–è¯­ä¹‰å¹¶è¿”å›žæˆåŠŸï¼Œå³ä½¿æ²¡æœ‰æˆåŠŸè¿”å›žclientä¹Ÿä¼šåœ¨ä¸‹æ¬¡è¯·æ±‚è¿”å›žOKï¼›åªæœ‰åœ¨ä¸ç¬¦åˆé…ç½®æ¡ä»¶çš„æƒ…å†µä¸‹è¿”å›žä¿¡æ¯ç»™clientï¼Œclientæ‰ä¼šå°è¯•æ›´æ–°é…ç½®å¹¶å‘å…¶ä»–groupå°è¯•ï¼Œå³é‡å¤å‘ä¸åŒgroupè¿›è¡Œappendçš„å‰ææ˜¯å‰ä¸€æ¬¡appendå¤±è´¥ï¼Œå› è€Œå‡ºçŽ°çš„bugä¸Žé¢„æœŸåˆ†æžç»“æžœå‡ºçŽ°å†²çªï¼Œå¯„ï¼ðŸ˜­ðŸ˜­ðŸ˜­

æ·±å…¥æ¨¡æ‹Ÿäº†ä¸€éé‡å¯åŽå‘½ä»¤çš„æäº¤ï¼Œå¾—å‡ºäº†ä¸€ç§ç¨‹åºçš„å¯èƒ½æ€§ï¼šç¨‹åºé‡å¯åŽå°†ç»§ç»­åº”ç”¨æ—¥å¿—ä¸­çš„æ“ä½œï¼Œæ—¥å¿—ä¸­æ­¤æ—¶å¯èƒ½åŒ…å«ä¸¤æ¡ç›¸åŒå†…å®¹è€ŒConfigIdä¸åŒçš„æ“ä½œï¼Œå‰é¢çš„æ“ä½œå› ä¸ºConfigIdæ›´æ—§å› æ­¤è¿”å›žäº†ErrWrongGroupï¼Œä¸”å› ä¸ºclientåŒæ—¶ä¹Ÿè¯·æ±‚äº†RPCï¼Œè¯¥æ—§æ“ä½œé€šè¿‡æ­¤æ—¶çš„RPCé€šé“è¿”å›žErrWrongGroupç»™clientï¼Œè€Œæ—¥å¿—ä¸­æ–°çš„æ“ä½œæ°å¥½ç¬¦åˆæ­¤æ—¶çš„é…ç½®æ¡ä»¶ä»Žè€Œæ‰§è¡Œï¼›æ­¤æ—¶è‹¥configåˆè¿›è¡Œäº†ä¸€æ¬¡æ›´æ–°ï¼Œå°†å¯¹åº”çš„shardè½¬ç§»åˆ°å¦ä¸€groupï¼ŒåŽŸå…ˆæŽ¥æ”¶åˆ°ErrWrongGroupçš„clientå°±ä¼šå°†è¯¥æ“ä½œè½¬å‘ç»™æ–°çš„groupï¼Œæ–°groupåˆ™å†æ¬¡æ‰§è¡Œå‘½ä»¤ä»Žè€Œé€ æˆé‡å¤appendã€‚æœ¬è´¨åœ¨äºŽæ—§æ“ä½œçš„ç»“æžœé€šè¿‡æ–°è°ƒç”¨RPCçš„é€šé“ä¼ å‡ºï¼Œä»Žè€ŒåŒä¸€ä¸ªæ“ä½œåœ¨ä¸¤ä¸ªgroupå…ˆåŽè¿›è¡Œã€‚

è¿™ç§æƒ…å†µåœ¨å°è¯•è¿‡ç¨‹ä¸­å‘çŽ°ä¸€ç§æ–¹æ³•ï¼Œæ˜¯åœ¨applyæ“ä½œæ—¶ï¼Œä¸å¯¹`kv.config.Num == op.ConfigId`æ£€æŸ¥æ˜¯å¦åŒ¹é…ï¼Œåªè¦serverçš„`kv.ownedShards[op.ShardId]`ä¸ºçœŸï¼Œå³æ­¤æ—¶serverå®žé™…æŒæœ‰shardçš„æ‰€æœ‰æƒï¼Œå°±è¿›è¡Œapplyæ“ä½œã€‚è¿™ç§æ–¹æ³•æ²»æ ‡ä¸æ²»æœ¬ï¼Œåªå¯¹è¯¥æµ‹è¯•ç‚¹æƒ…å†µæœ‰æ•ˆï¼Œåœ¨TestConcurrent3ä¼šå†æ¬¡å‡ºçŽ°é‡å¤appendã€‚æ¯”è¾ƒç®€å•å½»åº•çš„è§£å†³åŠžæ³•æ˜¯åœ¨shardè½¬ç§»æ—¶åŒæ—¶å¯¹æ–°groupæ›´æ–°`Clientseq`ã€‚

æµ‹è¯•20æ¬¡é€šè¿‡

![image-20240723232827001](MIT 6.824.assets/image-20240723232827001.png)

## åŽè®°

ç´¯ç´¯ç´¯ç´¯ç´¯ç´¯ 

æ²¡æå‰æŠŠå®žçŽ°åŠŸèƒ½çš„æ•´ä¸ªé€»è¾‘æ¢³ç†å®Œå–„å°±å¼€åŠ¨ï¼Œç»“æžœå°±æ˜¯debugåˆ°ç§ƒå¤´

> Think twice, code once.
